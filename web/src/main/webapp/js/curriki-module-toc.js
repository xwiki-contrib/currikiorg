(function(){Ext.ns("Curriki.module.toc");Ext.ns("Curriki.data.toc");var B=Curriki.module.toc;var A=Curriki.data.toc;B.init=function(){B.vars={};B.getQueryParam=function(D){D=D.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var C="[\\?&]"+D+"=([^&#]*)";var F=new RegExp(C);var E=F.exec(window.location.href);if(E==null){return""}else{return E[1]}};Ext.ns("Curriki.ui.treeLoader");Curriki.ui.treeLoader.TOC=function(C){Curriki.ui.treeLoader.TOC.superclass.constructor.call(this)};Ext.extend(Curriki.ui.treeLoader.TOC,Curriki.ui.treeLoader.Base,{setChildHref:true,setFullRollover:true,setTitleInRollover:true,setUniqueId:true,hideInvalid:true,truncateTitle:125});Ext.tree.TreeNodeUI.prototype.renderElements=function(F,K,J,L){this.indentMarkup=F.parentNode?F.parentNode.ui.getChildIndent():"";var G=typeof K.checked=="boolean";var D=K.href?K.href:Ext.isGecko?"":"#";var E=['<li class="x-tree-node"><div ext:tree-node-id="',F.id,'" class="x-tree-node-el x-tree-node-leaf x-unselectable ',K.cls,'" unselectable="on">','<span class="x-tree-node-indent">',this.indentMarkup,"</span>",'<img src="',this.emptyIcon,'" class="x-tree-ec-icon x-tree-elbow" />','<img src="',K.icon||this.emptyIcon,'" class="x-tree-node-icon',(K.icon?" x-tree-node-inline-icon":""),(K.iconCls?" "+K.iconCls:""),'" unselectable="on" />',G?('<input class="x-tree-node-cb" type="checkbox" '+(K.checked?'checked="checked" />':"/>")):"",'<a hidefocus="on" class="x-tree-node-anchor" href="',D,'" tabIndex="20" ',K.hrefTarget?' target="'+K.hrefTarget+'"':"",'><span unselectable="on">',F.text,"</span></a></div>",'<ul class="x-tree-node-ct" style="display:none;"></ul>',"</li>"].join("");var C;if(L!==true&&F.nextSibling&&(C=F.nextSibling.ui.getEl())){this.wrap=Ext.DomHelper.insertHtml("beforeBegin",C,E)}else{this.wrap=Ext.DomHelper.insertHtml("beforeEnd",J,E)}this.elNode=this.wrap.childNodes[0];this.ctNode=this.wrap.childNodes[1];var I=this.elNode.childNodes;this.indentNode=I[0];this.ecNode=I[1];this.iconNode=I[2];var H=3;if(G){this.checkbox=I[3];this.checkbox.defaultChecked=this.checkbox.checked;H++}this.anchor=I[H];this.textNode=I[H].firstChild};B.displayMainPanel=function(C){B.vars.panel=new Ext.tree.TreePanel({id:"TOCPanel",applyTo:"resource-toc",title:_("curriki.toc.title"),autoHeight:true,cls:"resource resource-toc",border:false,useArrows:true,lines:true,containerScroll:false,enableDD:false,loader:new Curriki.ui.treeLoader.TOC(),root:C,listeners:{beforeclick:{fn:function(D,F){var E=D.getPath().replace(/:\d+(\/|$)/g,"$1").replace(/\//g,";").replace(/;[^;]*$/,"");var G=Curriki.module.toc.getQueryParam("viewer");if(G!==""){G="&viewer="+G}window.location.href="/xwiki/bin/view/"+(D.attributes.pageName||D.id).replace(".","/")+"?bc="+E+G;return false}},load:{fn:function(){if(typeof B.vars.foundSelect==="undefined"){var D=C.findChild("id",A.selected);if(!Ext.isEmpty(D)){D.select();D.ensureVisible();B.vars.foundSelect=true}}}}}})};B.buildTree=function(){var C=A.tocData;if(!Ext.isEmpty(C.addCls)){C.addCls=C.addCls+" toc-top"}else{C.addCls=" toc-top"}C.listeners={beforecollapse:{fn:function(){return false}}};var D=new Curriki.ui.treeLoader.TOC();C=D.createNode(C);return C};B.display=function(){B.displayMainPanel(B.buildTree())};B.initialized=true;return true};B.start=function(){if(B.init()){B.display()}};Ext.onReady(function(){Curriki.data.EventManager.on("Curriki.data:ready",function(){Curriki.module.toc.start()})})})();