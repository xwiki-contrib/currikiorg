
####################################	If not login, show login information
#if( $context.user=="XWiki.XWikiGuest" )
  #set( $logredir = $xwiki.getRequestURL() )
  #set( $url = $xwiki.getURL("XWiki.XWikiLogin","login","xredirect=$logredir") )
  $msg.get("createresources.needaccount", [$url])
#else
####################################	If logined, show ACELessonPlan page
  #includeMacros("CreateResources.StyledMacros")
  #set( $pageName   = $request.getParameter("pageName") )
  #set( $cameFrom   = $request.getParameter("cameFrom") )
  #set( $flow       = $request.getParameter("flow") )
  #set( $parentPage = $request.getParameter("parentPage") )
  #set( $publishSpace = $request.getParameter("publishSpace") )
  #if( "$!pageName" != "" )
	 #set( $newAsset  = $xwiki.curriki.fetchAsset($pageName) )
  #else
	 #set( $newAsset = $xwiki.curriki.createAsset($xwiki.null) )
  #end

####################################	If newAsset is null, show error message
  #if( "$!newAsset"=="" )
	#if( "$!pageName" != "" )<p>asset creation error:</p>#else<p>asset lookup error:</p>#end
	<dl>
	  <dt>request.method</dt><dd>$!request.method</dd>
	  <dt>request.page</dt><dd>$!request.page</dd>
	  <dt>getParameter("pageName")</dt><dd>$!pageName</dd>
	  <dt>getParameter("cameFrom")</dt><dd>$!cameFrom</dd>
	  <dt>getParameter("flow")</dt><dd>$!flow</dd>
	  <dt>getParameter("parentPage")</dt><dd>$!parentPage</dd>
	  <dt>getParameter("publishSpace")</dt><dd>$!publishSpace</dd>
	</dl>
  #else
####################################	else ,show page
{pre}
<script language="javascript" type="text/javascript">

function checkStandardLessonPlanForm() {
  var missed_fields_str = '';
  if (getFieldContentStr('CurrikiCode.AssetClass_0_title') == null) {
	missed_fields_str = appendSeparatedErrorMessageStr(missed_fields_str, '$msg.get('lesson.plan.required.fields.dialog.title')');
  }
  if (getFieldContentStr('CurrikiCode.AssetClass_0_description') == null) {
	missed_fields_str = appendSeparatedErrorMessageStr(missed_fields_str, '$msg.get('lesson.plan.required.fields.dialog.description')');
  }
  {
	var form_fw_items = getFieldContentStr('CurrikiCode.AssetClass_0_fw_items');
	if ((form_fw_items == null) || (form_fw_items == 'FW_masterFramework.WebHome')) {
	  missed_fields_str = appendSeparatedErrorMessageStr(missed_fields_str, '$msg.get('lesson.plan.required.fields.dialog.subject')');
	}
  }
  { // Eductional-Level -- for validation, must look at "checked" on each button.
	var one_checked = false;
	for (var idx = 0, form_checkboxes = document.forms.inline['CurrikiCode.AssetClass_0_educational_level'];
	 ((idx < form_checkboxes.length) && !one_checked);
	 idx++) {
	  if (form_checkboxes[idx].checked) {
	one_checked = true;
	  }
	}
	if (!one_checked) {
	  missed_fields_str = appendSeparatedErrorMessageStr(missed_fields_str, '$msg.get('lesson.plan.required.fields.dialog.level')');
	}
  }

  if (getFieldContentStr('slp_number_days') == null) {
	missed_fields_str = appendSeparatedErrorMessageStr(missed_fields_str, '$msg.get('lesson.plan.required.fields.dialog.numberdays')');
  }
  if (getFieldContentStr('slp_prior_knowledge') == null) {
	missed_fields_str = appendSeparatedErrorMessageStr(missed_fields_str, '$msg.get('lesson.plan.required.fields.dialog.priorknowledge')');
  }
  if (getFieldContentStr('slp_lesson_objective') == null) {
	missed_fields_str = appendSeparatedErrorMessageStr(missed_fields_str, '$msg.get('lesson.plan.required.fields.dialog.lessonobjective')');
  }
  if (getFieldContentStr('slp_lesson_assessment') == null) {
	missed_fields_str = appendSeparatedErrorMessageStr(missed_fields_str, '$msg.get('lesson.plan.required.fields.dialog.lessonassessment')');
  }

if(!chekcTableText()){
	missed_fields_str = appendSeparatedErrorMessageStr(missed_fields_str, '$msg.get('lesson.plan.required.fields.dialog.procedures')');
}

  if (getFieldContentStr('CurrikiCode.AssetLicenseClass_0_rightsHolder') == null) {
	missed_fields_str = appendSeparatedErrorMessageStr(missed_fields_str, '$msg.get('lesson.plan.required.fields.dialog.rights')');
  }
  if (getAttachmentsSize() > $msg.get("lesson.plan.file.size.maximum")) {
	missed_fields_str = missed_fields_str + '\n\n' + '$msg.get('lesson.plan.file.size.oversize')';
  }
  var error_msg = "";
  if(missed_fields_str != ''){
	error_msg = '$msg.get('lesson.plan.required.fields.dialog')' + missed_fields_str;
  }else{
	if (getFieldContentStr('CurrikiCode.AssetClass_0_title').length > $msg.get("resource.title.maxlength")) {
	  error_msg = '$msg.get("ace.lesson.plan.title.more.250")';
	}
  }

  if (error_msg != '') { // since theres error messages, validation failed... bail out.
	alert(error_msg);
	setTextAssetToWikiText('$msg.get('form.done.wysiwyg.error.wikitext')');  // not POSTing due to 'false' return below, so this should not matter -- reset in case of going "back" in browser after successful POST??
	setSuccessMessage('');     //not POSTing due to 'false' return below, so this should not matter -- reset in case of going "back" in browser after successful POST??
	return false;
  }
  else {

	setTextAssetToWikiText(formatTextareasIntoWikiText());
	setSuccessMessage('$msg.get('form.done.created.lessonplan')');
	return true;
  }
}

function checkStandardLessonPlanDirty() {
  if (getAttachmentsSize() > 0) {
	return true;
  }
  if (getFieldContentStr('CurrikiCode.AssetClass_0_title') != null) {
	return true;
  }
  if (getFieldContentStr('CurrikiCode.AssetClass_0_description') != null) {
	return true;
  }
  if (getFieldContentStr('slp_number_days') != null) {
	return true;
  }
  if (getFieldContentStr('slp_prior_knowledge') != null) {
	return true;
  }
  if (getFieldContentStr('slp_lesson_objective') != null) {
	return true;
  }
  if (getFieldContentStr('slp_lesson_assessment') != null) {
	return true;
  }

  return false;
}

function formatTextareasIntoWikiText() {
  var slp_str = '';		// the string we concat into the TextAssetClass contents
  var title_markup_str = '*';
  var vert_break_str = '\\\\\n\n'

  slp_str = title_markup_str + '$msg.get("ace.lesson.plan.output.heading.content")' + title_markup_str +  vert_break_str + '#' + 'currikiACELPIcon()';

  {
	var form_number_days = getFieldContentStr('slp_number_days');
	if (form_number_days != null) {
	  form_number_days = form_number_days.replace(/\r\n/g,'\\\\').replace(/\n/g,'\\\\');
	  slp_str = ((slp_str != '') ? (slp_str + vert_break_str) : '') + title_markup_str + '$msg.get("ace.lesson.plan.number.days.title")' + title_markup_str +  vert_break_str + form_number_days;
	}
  }

  {
	var form_prior_knowledge = getFieldContentStr('slp_prior_knowledge');
	if (form_prior_knowledge != null) {
	  form_prior_knowledge = form_prior_knowledge.replace(/\r\n/g,'\\\\').replace(/\n/g,'\\\\');
	  slp_str = ((slp_str != '') ? (slp_str + vert_break_str) : '') + title_markup_str + '$msg.get("ace.lesson.plan.prior.knowledge.title")' + title_markup_str +  vert_break_str + form_prior_knowledge;
	}
  }
  {
	var form_lesson_objective = getFieldContentStr('slp_lesson_objective');
	if (form_lesson_objective != null) {
	  form_lesson_objective = form_lesson_objective.replace(/\r\n/g,'\\\\').replace(/\n/g,'\\\\');
	  slp_str = ((slp_str != '') ? (slp_str + vert_break_str) : '') + title_markup_str + '$msg.get("ace.lesson.plan.lesson.objective.title")' + title_markup_str +  vert_break_str + form_lesson_objective;
	}
  }
  {
	var form_lesson_assessment = getFieldContentStr('slp_lesson_assessment');
	if (form_lesson_assessment != null) {
	  form_lesson_assessment = form_lesson_assessment.replace(/\r\n/g,'\\\\').replace(/\n/g,'\\\\');
	  slp_str = ((slp_str != '') ? (slp_str + vert_break_str) : '') + title_markup_str + '$msg.get("ace.lesson.plan.lesson.assessment.title")' + title_markup_str +  vert_break_str + form_lesson_assessment;
	}
  }
  {
	var form_benchmark_standards = getFieldContentStr('slp_benchmark_standards');
	if (form_benchmark_standards != null) {
	  form_benchmark_standards = form_benchmark_standards.replace(/\r\n/g,'\\\\').replace(/\n/g,'\\\\');
	  slp_str = ((slp_str != '') ? (slp_str + vert_break_str) : '') + title_markup_str + '$msg.get("ace.lesson.plan.benchmark.standards.title")' + title_markup_str +  vert_break_str + form_benchmark_standards;

	}
  }
  {
	var form_materials_needed = getFieldContentStr('slp_materials_needed');
	if (form_materials_needed != null) {
	  form_materials_needed = form_materials_needed.replace(/\r\n/g,'\\\\').replace(/\n/g,'\\\\');
	  slp_str = ((slp_str != '') ? (slp_str + vert_break_str) : '') + title_markup_str + '$msg.get("ace.lesson.plan.materials.needed.title")' + title_markup_str +  vert_break_str + form_materials_needed;
	}
  }
  {
	var form_enrichment = getFieldContentStr('slp_enrichment');
	if (form_enrichment != null) {
	  form_enrichment = form_enrichment.replace(/\r\n/g,'\\\\').replace(/\n/g,'\\\\');
	  slp_str = ((slp_str != '') ? (slp_str + vert_break_str) : '') + title_markup_str + '$msg.get("ace.lesson.plan.enrichment.title")' + title_markup_str +  vert_break_str + form_enrichment;
	}
  }
  {
	var form_accommodations = getFieldContentStr('slp_accommodations');
	if (form_accommodations != null) {
	  form_accommodations = form_accommodations.replace(/\r\n/g,'\\\\').replace(/\n/g,'\\\\');
	  slp_str = ((slp_str != '') ? (slp_str + vert_break_str) : '') + title_markup_str + '$msg.get("ace.lesson.plan.accommodations.title")' + title_markup_str +  vert_break_str + form_accommodations;
	}
  }
  {
	var form_anticipated_problems = getFieldContentStr('slp_anticipated_problems');
	if (form_anticipated_problems != null) {
	  form_anticipated_problems = form_anticipated_problems.replace(/\r\n/g,'\\\\').replace(/\n/g,'\\\\');
	  slp_str = ((slp_str != '') ? (slp_str + vert_break_str) : '') + title_markup_str + '$msg.get("ace.lesson.plan.anticipated.problems.title")' + title_markup_str +  vert_break_str + form_anticipated_problems;
	}
  }

  {	//js table
	var form_table_text = getTableText();
	if (form_table_text != null) {
	  slp_str = ((slp_str != '') ? (slp_str + vert_break_str) : '') + title_markup_str + '$msg.get("ace.lesson.plan.procedures.title")' + title_markup_str +  vert_break_str + form_table_text
	}
  }

  {
	var file_list = getAttachmentsNames();
	if (file_list.length > 0) {
	  slp_str = ((slp_str != '') ? (slp_str + vert_break_str) : '') + title_markup_str + '$msg.get("ace.lesson.plan.attachments.title")' + title_markup_str + vert_break_str + '#' + 'currikiattachmentBegin()\n';
	  for (var idx = 0; (idx < file_list.length); idx++) {
	// for macro currikiattachment($fname) see web/src/main/webapp/skins/curriki8/macros.vm
	slp_str = slp_str + '#' + 'currikiattachment("' + file_list[idx] + '")\n';
	  }
	  slp_str = slp_str + '#' + 'currikiattachmentEnd()\n' + vert_break_str;
	}
  }

  {
	slp_str = ((slp_str != '') ? (slp_str + vert_break_str) : '') + title_markup_str + '$msg.get("ace.lesson.plan.changes_heading")' + title_markup_str +  vert_break_str + '$msg.get("ace.lesson.plan.changes_content")';
	slp_str = ((slp_str != '') ? (slp_str + vert_break_str) : '') + title_markup_str + '$msg.get("ace.lesson.plan.whatworked_heading")' + title_markup_str +  vert_break_str + '$msg.get("ace.lesson.plan.whatworked_content")';
  }

  return (slp_str);
}

function setTextAssetToWikiText(str) {
  var input_field_TextAssetClass_o = $('CurrikiCode.TextAssetClass_0_text');
  if (input_field_TextAssetClass_o != null) {
	input_field_TextAssetClass_o.value = str;
  }
  else { alert('error in setTextAssetToWikiText()'); }
}

function getFieldContentStr(field_id_str) {
  var field_content_o   = $(field_id_str);
  var field_content_str = (field_content_o==null) ? "" : field_content_o.value;
  if ((field_content_str.length < 1) || (field_content_str.trim() == '')) {
	return (null);
  }
  else {
	return (field_content_str);
  }
}

function setSuccessMessage(str) {
  var input_field_successMessage_o = $('successMessage');
  if (input_field_successMessage_o != null) {
	input_field_successMessage_o.value = str;
  }
  else { alert('error in setSuccessMessage()'); }
}

function appendSeparatedErrorMessageStr(message_str, missed_field_err_str) {
  return(message_str + '\n\t\t' + missed_field_err_str);
}

var needUnloadDialog = false;
function clearUnloadDialog() {
  needUnloadDialog = false;
}

function onWindowUnloading(e) {
  // if the form is not "dirty" don't pop form.leaving.dialog
  if (needUnloadDialog && checkStandardLessonPlanDirty()) {
	e.browserEvent.returnValue = "$msg.get('form.leaving.dialog')";
  }
}

function setUnloadDialog() {
  // window.onbeforeunload = unloadDialog;
  Ext.EventManager.on(window, 'beforeunload', onWindowUnloading);
  needUnloadDialog = true;
}

function getAttachmentsSize() {
  return (window.frames['attachment_iframe'].getAttachmentsSize());
}

function getAttachmentsNames() {
  return (window.frames['attachment_iframe'].getAttachmentsNames());
}

function setAttachmentsIframeSize() {
  var iframe_o = document.getElementById('attachment_iframe');
  try {
	if (iframe_o != null) {
	  iframe_o.height = iframe_o.style.height = 50;  // attempt reset because FF behavior is grow-only
	}
	// this is portable way of getting at iframe DOM content per
	// http://www.mabaloo.com/Web-Development/Creating-controlling-and-manipulating-an-Iframe-through-JavaScript.html
	var doc_o = (iframe_o.contentWindow || iframe_o.contentDocument);
	if (doc_o.document) {
	  doc_o = doc_o.document;
	}
	// the iframe needs more space than 'scrollHeight' says, or we get
	// scrollbars. 5 seems to accomodate the inner and outer margin, and
	// inner and outer border, with one pixel for the margin itself.
	// nb: iframe_o.style.height only works in IE, does nothing in FF.
	// do em both for good measure?!
	if (iframe_o != null) {
	   if (Ext.isIE6) {
	     iframe_o.height = iframe_o.style.height = doc_o.body.scrollHeight * 2 + 5;
	   } else {
	     iframe_o.height = iframe_o.style.height = doc_o.body.scrollHeight + 5;
	   }
	}
  }
  catch(e) {
	if (iframe_o != null) {
	  iframe_o.height = iframe_o.style.height = 300; // bigger default height value if things go wrong
	}
  }
}
</script>

<style type="text/css">
.x-grid3-td-0{border-right: 1px solid lightgrey; padding-left: 0px !important;padding-right: 0px !important}
.x-grid3-td-1{border-right: 1px solid lightgrey; padding-left: 0px !important;padding-right: 0px !important}
.x-grid3-td-2{padding-left: 0px !important;padding-right: 0px !important}
.x-grid3-col-0{white-space: normal; word-wrap:break-word;}
.x-grid3-col-1{white-space: normal; word-wrap:break-word;}
.x-grid3-col-2{white-space: normal; word-wrap:break-word;}
.x-form-field-ace{overflow:hidden}

input {	width:expression(this.type=="text" ? "83%" : "style"); }
</style>
<script type="text/javascript" src="/xwiki/yui/yahoo/yahoo-min.js" ></script>
<script type="text/javascript" src="/xwiki/yui/treeview/treeview-min.js" ></script>
<script type="text/javascript" src="/xwiki/yui/treeview/checknode.js"></script>
<script>
// ----------------------------------- override YUI checknode method -------------------
/**
 * jsj add
 *Invoked when the user press space key
 */
YAHOO.widget.CheckNode.prototype.getKeyCheck = function() {
    return " if( 32 == (window.event ? event.keyCode : event.which) ){ "+"YAHOO.widget.TreeView.getNode(\'" + this.tree.id + "\'," +
        this.index + ").checkClick();"+"if (event.preventDefault) event.preventDefault( ); else event.returnValue = false;}";
};

// Overrides YAHOO.widget.TextNode
YAHOO.widget.CheckNode.prototype.getNodeHtml = function() {
    // this.logger.log("Generating html");
    var sb = new Array();

    sb[sb.length] = '<table border="0" cellpadding="0" cellspacing="0">';
    sb[sb.length] = '<tr>';

    for (i=0;i<this.depth;++i) {
        sb[sb.length] = '<td class="' + this.getDepthStyle(i) + '">&#160;</td>';
    }

    sb[sb.length] = '<td';
    sb[sb.length] = ' id="' + this.getToggleElId() + '"';
    sb[sb.length] = ' class="' + this.getStyle() + '"';
    if (this.hasChildren(true)) {
        sb[sb.length] = ' onmouseover="this.className=';
        sb[sb.length] = 'YAHOO.widget.TreeView.getNode(\'';
        sb[sb.length] = this.tree.id + '\',' + this.index +  ').getHoverStyle()"';
        sb[sb.length] = ' onmouseout="this.className=';
        sb[sb.length] = 'YAHOO.widget.TreeView.getNode(\'';
        sb[sb.length] = this.tree.id + '\',' + this.index +  ').getStyle()"';
    }
    sb[sb.length] = ' onclick="javascript:' + this.getToggleLink() + '">&#160;';
    sb[sb.length] = '</td>';

    // check box
    sb[sb.length] = '<td';
    sb[sb.length] = ' id="' + this.getCheckElId() + '"';
    sb[sb.length] = ' class="' + this.getCheckStyle() + '"';
    sb[sb.length] = ' onclick="javascript:' + this.getCheckLink() + '">';
    sb[sb.length] = '&#160;</td>';


    sb[sb.length] = '<td>';
    sb[sb.length] = '<a';
    sb[sb.length] = ' id="' + this.labelElId + '"';
    sb[sb.length] = ' class="' + this.labelStyle + '"';
    sb[sb.length] = ' href="' + this.href + '"';
    sb[sb.length] = ' target="' + this.target + '"';
    if (this.hasChildren(true)) {
        sb[sb.length] = ' onmouseover="document.getElementById(\'';
        sb[sb.length] = this.getToggleElId() + '\').className=';
        sb[sb.length] = 'YAHOO.widget.TreeView.getNode(\'';
        sb[sb.length] = this.tree.id + '\',' + this.index +  ').getHoverStyle()"';
        sb[sb.length] = ' onmouseout="document.getElementById(\'';
        sb[sb.length] = this.getToggleElId() + '\').className=';
        sb[sb.length] = 'YAHOO.widget.TreeView.getNode(\'';
        sb[sb.length] = this.tree.id + '\',' + this.index +  ').getStyle()"';
    }
    sb[sb.length] = ' onkeypress="javascript:' + this.getKeyCheck(this.event)+'">';
    //sb[sb.length] = '>';
    sb[sb.length] = this.label;
    sb[sb.length] = '</a>';
    sb[sb.length] = '</td>';
    sb[sb.length] = '</tr>';
    sb[sb.length] = '</table>';

    return sb.join("");
};

var grid;                      // table
var isJumpToNext, isJumpToPre; // jump flag for table
var clickTabToNextNum=0, clickTabToPreNum=0, clickTabInGridToNextNum=0, clickTabInGridToPreNum=0;
// ------------------------------------ extend extjs ------------------------------------
Ext.apply(Ext.grid.GridView.prototype,{
	// remove red triangles
	doRender : function(cs, rs, ds, startRow, colCount, stripe){
		var ts = this.templates, ct = ts.cell, rt = ts.row, last = colCount-1;
		var tstyle = 'width:'+this.getTotalWidth()+';';
		var buf = [], cb, c, p = {}, rp = {tstyle: tstyle}, r;


		for(var j = 0, len = rs.length; j < len; j++){
			r = rs[j]; cb = [];
			var rowIndex = (j+startRow);
			for(var i = 0; i < colCount; i++){
				c = cs[i];
				p.id = c.id;
				p.css = i == 0 ? 'x-grid3-cell-first ' : (i == last ? 'x-grid3-cell-last ' : '');
				p.attr = p.cellAttr = "";
				p.value = c.renderer(r.data[c.name], p, r, rowIndex, i, ds);
				p.style = c.style;
				if(p.value == undefined || p.value === "") p.value = "&#160;";
				cb[cb.length] = ct.apply(p);
			}
			var alt = [];
			if(stripe && ((rowIndex+1) % 2 == 0)){
				alt[0] = "x-grid3-row-alt";
			}
			if(r.dirty){
				alt[1] = " x-grid3-dirty-row";
			}
			rp.cols = colCount;
			if(this.getRowClass){
				alt[2] = this.getRowClass(r, rowIndex, rp, ds);
			}
			rp.alt = alt.join(" ");
			rp.cells = cb.join("");
			buf[buf.length] =  rt.apply(rp);
		}
		return buf.join("");
	},

	focusCell : function(row, col, hscroll){
		row = Math.min(row, Math.max(0, this.getRows().length-1));
		var xy = this.ensureVisible(row, col, hscroll);
		this.focusEl.setXY(xy||this.scroller.getXY());

		if(Ext.isGecko){
		   // this.focusEl.focus();
		}else{
		   // this.focusEl.focus.defer(1, this.focusEl);
		}
	},

	// private
	layout : function(){
		if(!this.mainBody){
			return; // not rendered
		}
		var g = this.grid;
		var c = g.getGridEl();
		var csize = c.getSize(true);
		var vw = csize.width;

		if(vw < 20 || csize.height < 20){ // display: none?
			return;
		}

		if(g.autoHeight){
			this.scroller.dom.style.overflow = 'hidden';
		}else{
			this.el.setSize(csize.width, csize.height);

			var hdHeight = this.mainHd.getHeight();
			var vh = csize.height - (hdHeight);

			this.scroller.setSize(vw, vh);
			if(this.innerHd){
				this.innerHd.style.width = (vw)+'px';
			}
		}
		if(this.forceFit){
			if(this.lastViewWidth != vw){
				this.fitColumns(false, false);

				this.lastViewWidth = vw;
			}
		}else {
			this.autoExpand();
			this.syncHeaderScroll();
		}
		this.onLayout(vw, vh);
	}
});
Ext.apply(Ext.grid.EditorGridPanel.prototype,{
	// multi-lines wrapper and clear default value
	preEditValue : function(r, field){
		var value = r.data[field];
		if(!r.dirty||(r.dirty && typeof r.modified[field] == 'undefined')){
			value='';
		}else if(typeof value == 'string'){
			value=value.replace(/<br\/>/gi,'\r\n');
			value=this.autoEncode ? Ext.util.Format.htmlDecode(value) : value;
		}
		return value;
	},
	postEditValue : function(value, originalValue, r, field){
		if(typeof value == 'string'){
			value=this.autoEncode ? Ext.util.Format.htmlEncode(value) : value;
			value=value.replace(/\r\n/gi,"<br/>").replace(/\n/gi,'<br/>');
		}
		delete Ext.currentCellNode;
		return value;
	}
});
Ext.apply(Ext.grid.GridEditor.prototype, {
	// set auto size
	autoSize: true,
	doAutoSize : function(){
		if(this.autoSize){
			var parentNode=this.boundEl.dom.parentNode;
			var width=parentNode.clientWidth;
			var height=parentNode.clientHeight;
			switch(this.autoSize){
				case "width":
					this.setSize(width,  "");
				break;
				case "height":
					this.setSize("",  height-1);
				break;
				default:
					this.setSize(width,  height-1);
			}
			Ext.currentCellNode=parentNode;
		}
	}
});
Ext.apply(Ext.form.TextArea.prototype, {
	// auto size cell
	onKeyUpBuffered : function(e){
		if(!e.isNavKeyPress()||e.getKey()==e.ENTER){
			this.autoSize();
		} else if (e.isNavKeyPress()) {
			if (isJumpToNext) {
				clickTabToNextNum = clickTabToNextNum + 1;
				if (clickTabToNextNum == 2) {
					isJumpToNext = false;
					clickTabToNextNum = 0;
					document.getElementById("addRowBtn").focus();
				}
			} else if (isJumpToPre) {
				clickTabToPreNum = clickTabToPreNum + 1;
				if (clickTabToPreNum == 2) {
					isJumpToPre = false;

					clickTabToPreNum = 0;
					document.getElementById("slp_anticipated_problems").focus();
				}
			}
		}
	},
	autoSize : function(){
		if(!this.grow || !this.textSizeEl){
			return;
		}
		var el = this.el;
		var v = el.dom.value;
		var ts = this.textSizeEl;
		ts.innerHTML = '';
		ts.appendChild(document.createTextNode(v));
		v = ts.innerHTML;
		Ext.fly(ts).setWidth(this.el.getWidth());
		if(v.length < 1){
			v = "&#160;&#160;";
		}else{
			if(Ext.isIE){
				v = v.replace(/\n/g, '<p>&#160;</p>');
			}
			v += this.growAppend;
		}
		ts.innerHTML = v;
		var h = Math.min(this.growMax, Math.max(ts.offsetHeight, this.growMin)+this.growPad);
		if(h != this.lastHeight){
			if(Ext.currentCellNode){
				if(h>Ext.currentCellNode.clientHeight){
					this.lastHeight = h;
					this.el.setHeight(h);
					this.fireEvent("autosize", this, h);
					if(Ext.isIE){
						Ext.currentCellNode.style.height=h;
					}else{
						Ext.currentCellNode.setStyle('height:'+h+'px');

					}
				}
			}else{
				this.lastHeight = h;
				this.el.setHeight(h);
				this.fireEvent("autosize", this, h);
			}
		}
	}
});

// ------------------------------------ wzToolTip tt_Init ------------------------------------
function tt_Init2(){
	if(!(tt_op || tt_n4 || tt_n6 || tt_ie || tt_w3c)) return;
	var htm = tt_n4? '<div style="position:absolute;"></div>' : '', tags, t_tj, over, esc = 'return escape(';
	var i = tt_tags.length;
	while(i--){
		tags = tt_ie? (document.all.tags(tt_tags[i]) || 1)
			: document.getElementsByTagName? (document.getElementsByTagName(tt_tags[i]) || 1)
			: (!tt_n4 && tt_tags[i]=="a")? document.links
			: 1;
		if(tt_n4 && (tt_tags[i] == "a" || tt_tags[i] == "layer")) tags = tt_N4Tags(tt_tags[i]);
		var j = tags.length;
		while(j--){
			if(typeof (t_tj = tags[j]).onmouseover == "function" && t_tj.onmouseover.toString().indexOf(esc) != -1 && !tt_n6 || tt_n6 && (over = t_tj.getAttribute("onmouseover")) && over.indexOf(esc) != -1){
				if(over) t_tj.onmouseover = new Function(over);
				var txt = unescape(t_tj.onmouseover());
				htm += tt_Htm(
					t_tj,
					"tOoLtIp"+i+""+j,
					txt.wzReplace("& ","&")
				);
				t_tj.onmouseover = new Function('e',
					'tt_Show(e,'+
					'"tOoLtIp' +i+''+j+ '",'+
					((typeof t_tj.T_ABOVE != tt_u)? t_tj.T_ABOVE : ttAbove)+','+
					((typeof t_tj.T_DELAY != tt_u)? t_tj.T_DELAY : ttDelay)+','+
					((typeof t_tj.T_FIX != tt_u)? '"'+t_tj.T_FIX+'"' : '""')+','+
					((typeof t_tj.T_LEFT != tt_u)? t_tj.T_LEFT : ttLeft)+','+
					((typeof t_tj.T_OFFSETX != tt_u)? t_tj.T_OFFSETX : ttOffsetX)+','+
					((typeof t_tj.T_OFFSETY != tt_u)? t_tj.T_OFFSETY : ttOffsetY)+','+
					((typeof t_tj.T_STATIC != tt_u)? t_tj.T_STATIC : ttStatic)+','+
					((typeof t_tj.T_STICKY != tt_u)? t_tj.T_STICKY : ttSticky)+','+
					((typeof t_tj.T_TEMP != tt_u)? t_tj.T_TEMP : ttTemp)+
					');'
				);
				t_tj.onmouseout = tt_Hide;
				if(t_tj.alt) t_tj.alt = "";
				if(t_tj.title) t_tj.title = "";
			}
		}
	}
	Element.insert("tooltip_div",{bottom:htm});
	if(document.getElementById) tt_ifrm = document.getElementById("TTiEiFrM");
}

// ------------------------------------ edit grid definition ------------------------------------

var data00 = "$msg.get('ace.lesson.plan.procedures.row1.time_sample')";
var data10 = "$msg.get('ace.lesson.plan.procedures.row2.time_sample')";
var data11 = "$msg.get('ace.lesson.plan.procedures.row2.learningtask_sample')";
var data12 = "$msg.get('ace.lesson.plan.procedures.row2.methodorprocedure_sample')";

var data=[
{id:1,time:data00,task:'',method:''},
{id:1,time:data10,task:data11,method:data12},
{id:1,time:'',task:'',method:''},
{id:1,time:'',task:'',method:''},
{id:1,time:'',task:'',method:''},
{id:1,time:'',task:'',method:''},
{id:1,time:'',task:'',method:''},
{id:1,time:'',task:'',method:''}
];

var store=new Ext.data.JsonStore(
{data:data,fields:["id","time","task","method"]});
#set($info_img = '/xwiki/skins/curriki8/icons/exclamation.png')
var tooltip1="<img class=\"tooltip\" alt=\"\" src=\"/xwiki/skins/curriki8/icons/exclamation.png\" ext:qtip=\"$msg.get("ace.lesson.plan.procedures.time.tooltip")\"/>";
var tooltip2="<img class=\"tooltip\" alt=\"\" src=\"/xwiki/skins/curriki8/icons/exclamation.png\" ext:qtip=\"$msg.get("ace.lesson.plan.procedures.learningtask.tooltip")\"/>";
var tooltip3="<img class=\"tooltip\" alt=\"\" src=\"/xwiki/skins/curriki8/icons/exclamation.png\" ext:qtip=\"$msg.get("ace.lesson.plan.procedures.methods.tooltip")\"/>";

var colM = new Ext.grid.ColumnModel([
		{id:"0",header:"Time"+tooltip1,dataIndex:"time",sortable:false,fixed:true,width:100,menuDisabled:true,editor:new Ext.form.TextArea({grow:true,fieldClass:'x-form-field-ace'})},
		{id:"1",header:"Learning Task"+tooltip2,dataIndex:"task",sortable:false,fixed:true,width:200,menuDisabled:true,editor:new Ext.form.TextArea({grow:true,fieldClass:'x-form-field-ace'})},
		{id:"2",header:"Method or Procedure"+tooltip3,dataIndex:"method",sortable:false,fixed:true,menuDisabled:true,editor:new Ext.form.TextArea({grow:true,fieldClass:'x-form-field-ace'})}
	]);


function fn() {
	grid = new Ext.grid.EditorGridPanel(
{renderTo:"procedures_div",title:"",height:200,width:570, cm:colM,store:store,autoExpandColumn:2,clicksToEdit:1,autoHeight:true,autoEncode:true,
	cls :' x-form-field-ace;',
	viewConfig: {scrollOffset: 2},
	fitContainer: true});

grid.on("cellclick", this.cellClick);
grid.on("afteredit",this.afterEdit,this);
grid.addListener("keyDown", function(e){
    if (e.isNavKeyPress()) {
			if (isJumpToNext) {
				clickTabInGridToNextNum = clickTabInGridToNextNum + 1;
				if (clickTabInGridToNextNum == 2) {
				    isJumpToNext = false;
					clickTabInGridToNextNum = 0;
					document.getElementById("addRowBtn").focus();
				}
			} else if (isJumpToPre) {
				clickTabInGridToPreNum = clickTabInGridToPreNum + 1;
				if (clickTabInGridToPreNum == 2) {
					isJumpToPre = false;
					clickTabInGridToPreNum = 0;
					document.getElementById("slp_anticipated_problems").focus();
				}
			}
		}
});
grid.getSelectionModel().on("cellselect", function(sel, row, col) {
	curRow = row;curCol = col;
	if (row !=0 && col !=0 && row == grid.getStore().getCount()-1 && col == grid.getColumnModel().getColumnCount()-1) {
		isJumpToNext = true;
	} else {
		isJumpToNext = false;
	}
	if (row == 0 && col == 0) {
		isJumpToPre = true;
	} else {
		isJumpToPre = false;
	}
});
tt_Init2();

}

Ext.onReady(fn);

function cellClick(obj, row, col, e){

	var record = obj.store.getAt(row);
	if(row == 0 && col == 0){
		if(record.get("time") == data00)
			record.set("time", "");
	}else if(row == 1 && col == 0){
		if(record.get("time") == data10)
			record.set("time", "");
	}else if(row == 1 && col == 1){
		if(record.get("task") == data11)
			record.set("task", "");
	}else if(row == 1 && col == 2){
		if(record.get("method") == data12)
			record.set("method", "");
	}
	//store.commitChanges();
}


function afterEdit(obj, row, col, e){
	var r=obj.record;
	var id=r.get("id");
	var name=r.get("name");
	//store.commitChanges();
	//Ext.MessageBox.alert("alertdiv","Hello,easyjf open source");
}

// insert new row
function addrow(){
	data=[{id:1,time:'',task:'',method:''}];
	store.loadData(data, true);
	return false;
}
function chekcTableText(){

	var arr = store.data;
	for(i=0;i<arr.length;i++){
		var record = store.getAt(i);
		if(i == 0){
			if((record.get("time") != data00 && record.get("time") != "") || record.get("task") != "" || record.get("method") != ""){
				return true;
			}
		}else if(i == 1){
			if((record.get("time") != data10 && record.get("time") != "") || (record.get("task") != data11 && record.get("task") != "")
				|| (record.get("method") != data12 && record.get("method") != "")){
				return true;
			}
		}else if(record.get("time") != "" || record.get("task") != "" || record.get("method") != ""){
			return true;
		}
	}
	return false;
}

function formatTableString(str){
	str = str.replace(/<br\/>/gi,'\r\n');
	str = Ext.util.Format.htmlDecode(str);
	str = formatString(str, /#/g, "&#35;");
	str = formatString(str, /1/g, "&#49;");
	str = formatString(str, /\*/g, "&#42;");
	str = formatString(str, /a/g, "&#97;");
	str = formatString(str, /A/g, "&#65;");
	str = formatString(str, /i/g, "&#105;");
	str = formatString(str, /I/g, "&#73;");
	str = formatString(str, /g/g, "&#103;");
	str = formatString(str, /h/g, "&#104;");
	str = formatString(str, /k/g, "&#107;");
	str = formatString(str, /_/g, "&#95;");
	str = formatString(str, /~/g, "&#126;");
	str = formatString(str, /-/g, "&#45;");
	str = formatString(str, /{/g, "&#123;");
	str = formatString(str, /}/g, "&#125;");
	str = formatString(str, /\(/g, "&#40;");
	str = formatString(str, /\)/g, "&#41;");
	str = formatString(str, /\|/g, "&#124;");
	str = formatString(str, /\$/g, "&#36;");
	str = formatString(str, /@/g, "&#64;");
	str = formatString(str, /\[/g, "&#91;");
	str = formatString(str, /\]/g, "&#93;");
	str = formatString(str, /</g, "&#60;");
	str = formatString(str, />/g, "&#62;");
	str = str.replace(/\r\n/gi,"\\\\")
	return str;
}
function formatString(str, reg, repls){
	return str.replace(reg, repls)
}

function getTableText(){
	var str = '\{table\}';
	str += 'Time | Learning Task | Method or Procedure\r\n';

	var arr = store.data;
	for(i=0;i<arr.length;i++){
		var record = store.getAt(i);
		var time = record.get("time");
		var task = record.get("task");
		var method = record.get("method");

		if(i == 0 && time == data00){
			time = "";
		}
		if(i == 1){
			if(time == data10){
				time = "";
			}
			if(task == data11){
				task = "";
			}
			if(method == data12){
				method = "";
			}
		}

		if(time != "" || task != "" || method != ""){
			time = formatTableString(time);
			time = (time == "" ? "&#160;" : time);
			task = formatTableString(task);
			task = (task == "" ? "&#160;" : task);
			method = formatTableString(method);
			method = (method == "" ? "&#160;" : method);
			str += time + ' | ' + task + ' | ' + method + ' \r\n';
		}
	}
	str += '\{table\}';

	return str;
}
</script>
{/pre}
####################################	JS end , title
  #set( $noDialogs = $request.getParameter("noDialogs") )  ## ?noDialogs=1 turns off add-path dialogs, for testing, or to enable "edit-again"
  <div class="header">
  #curriki_formtitle($msg.get("ace.lesson.plan.title"))
  $msg.get("ace.lesson.plan.title.description") <a href="$msg.get('ace.lesson.plan.title.description.link1.url')" target="_blank">$msg.get("ace.lesson.plan.title.description.link1")</a><span class="separator">&nbsp;|&nbsp;</span><a href="$msg.get('ace.lesson.plan.title.description.link3.url')" target="_blank">$msg.get("ace.lesson.plan.title.description.link3")</a><span class="separator">&nbsp;|&nbsp;</span><a href="$msg.get('ace.lesson.plan.title.description.link2.url')" target="_blank">$msg.get("ace.lesson.plan.title.description.link2")</a><a href="$msg.get('ace.lesson.plan.title.description.link2.thumbnail.url')"><img src="$msg.get('ace.lesson.plan.title.description.link2.thumbnail')" align="middle"></a>
  <br />$msg.get("form.required.fields.instruction")
  </div>
  <form action="" class="curriki-form1" id="inline" method="post">
	  <input type="hidden" name="xredirect" value="$xwiki.getFormEncoded($xwiki.getRequestURL())" />
	  ##sign validation result, default is validate not passed
	  <input type="hidden"  name="CurrikiCode.TextAssetClass_0_text" id="CurrikiCode.TextAssetClass_0_text" value="$msg.get('form.done.wysiwyg.error.wikitext')" />
	  <input type="hidden"  name="CurrikiCode.TextAssetClass_0_type" id="CurrikiCode.TextAssetClass_0_type" value="0" />
	  <input type="hidden"  name="CurrikiCode.AssetClass_0_instructional_component2" id="CurrikiCode.AssetClass_0_instructional_component2" value="curriculum_lp" />
	  <input type="hidden"  name="CurrikiCode.AssetClass_0_hidden_from_search" id="CurrikiCode.AssetClass_0_hidden_from_search" value="0" />
	  <input type="hidden"  name="CurrikiCode.AssetClass_0_category" id="CurrikiCode.AssetClass_0_category" value="text" />
	  ## successMessage is null, validation not passed
	  <input type="hidden" 	name="successMessage" id="successMessage" value=""      />
	  <input type="hidden" 	name="page"		value="$!request.page"		/>
	  <input type="hidden"	name="pageName"		value="$!newAsset.fullName"	/>
	  <input type="hidden"	name="publishSpace"	value="$!publishSpace"		/>
	  <input type="hidden"	name="parentPage"	value="$!parentPage"		/>
	  #if( "$!noDialogs"!="" )
		<input type="hidden"	name="noDialogs"	value="$noDialogs"		/>
	  #else
		<input type="hidden"	name="flow"		value="$!flow"			/>
			<input type="hidden"	name="createLessonURL"		value="$msg.get('ace.lesson.plan.url')"	/> ## for ICT
		<input type="hidden"	name="cameFrom"  #if( "$!cameFrom"=="" ) value="$msg.get('ace.lesson.plan.url')"  #else   value="$!cameFrom"   #end />
	  #end
####################################	step1
  #curriki_formpart_begin($msg.get("ace.lesson.plan.step1.header"))
  #curriki_forminstructions($msg.get("ace.lesson.plan.step1.instruction"))
  #curriki_formprompt($msg.get("ace.lesson.plan.title_title"), $msg.get("ace.lesson.plan.title_tooltip"), $msg.get("ace.lesson.plan.title_txt"), true, "medium")
  ##$newAsset.display("title","edit")
  <input type="text" id="CurrikiCode.AssetClass_0_title" name="CurrikiCode.AssetClass_0_title" maxlength="$msg.get("resource.title.maxlength")" />
  #curriki_formprompt($msg.get("ace.lesson.plan.description_title"), $msg.get("ace.lesson.plan.description_tooltip"), $msg.get("ace.lesson.plan.description_txt"), true, "medium")
  $newAsset.display("description","edit")
  <table class="subject-educational"><tbody><tr><td>
  #curriki_formprompt($msg.get("sri.fw_items_title"), $msg.get("sri.fw_items_tooltip"), $msg.get("sri.fw_items_txt"), true, "")
  $newAsset.display("fw_items","edit")
  </td><td>
  #curriki_formprompt($msg.get("sri.educational_level_title"), $msg.get("sri.educational_level_tooltip"), $msg.get("sri.educational_level_txt"), true, "medium")
  $newAsset.display("educational_level","edit")
  </td></tr></tbody></table> ##class="subject-educational"
  #curriki_formprompt($msg.get("sri.keywords_title"), $msg.get("sri.keywords_tooltip"), $msg.get("sri.keywords_txt"), false, "medium")
  $newAsset.display("keywords","edit")
  #curriki_formprompt($msg.get("sri.language_title"), $msg.get("sri.language_tooltip"), $msg.get("sri.language_txt"), false, "medium")
  $newAsset.display("language","edit")
  #curriki_formpart_end()
####################################	step2
  #curriki_formpart_begin($msg.get("ace.lesson.plan.step2.header")) ## {
  #curriki_forminstructions($msg.get("ace.lesson.plan.step2.instruction"))

  #curriki_formprompt($msg.get("ace.lesson.plan.introduction.title"), $msg.get("ace.lesson.plan.introduction.tooltip"), $msg.get("ace.lesson.plan.introduction.instruction"), true, "medium")
  <textarea id='slp_number_days' name='slp_number_days' class='curriki-form1_textarea'></textarea>

  #curriki_formprompt($msg.get("ace.lesson.plan.group.size.title"), $msg.get("ace.lesson.plan.group.size.tooltip"), $msg.get("ace.lesson.plan.group.size.instruction"), true, "medium")
  <textarea id='slp_prior_knowledge' name='slp_prior_knowledge' class='curriki-form1_textarea'></textarea>

  #curriki_formprompt($msg.get("ace.lesson.plan.learning.objectives.title"), $msg.get("ace.lesson.plan.learning.objectives.tooltip"), $msg.get("ace.lesson.plan.learning.objectives.instruction"), true, "medium")
  <textarea id='slp_lesson_objective' name='slp_lesson_objective' class='curriki-form1_textarea'></textarea>

  #curriki_formprompt($msg.get("ace.lesson.plan.assessment.title"), $msg.get("ace.lesson.plan.assessment.tooltip"), $msg.get("ace.lesson.plan.assessment.instruction"), true, "medium")
  <textarea id='slp_lesson_assessment' name='slp_lesson_assessment' class='curriki-form1_textarea'></textarea>


  #curriki_formprompt($msg.get("ace.lesson.plan.standards.title"), $msg.get("ace.lesson.plan.standards.tooltip"), $msg.get("ace.lesson.plan.standards.instruction"), false, "medium")
  <textarea id='slp_benchmark_standards' name='slp_benchmark_standards' class='curriki-form1_textarea'></textarea>

  #curriki_formprompt($msg.get("ace.lesson.plan.materials.title"), $msg.get("ace.lesson.plan.materials.tooltip"), $msg.get("ace.lesson.plan.materials.instruction"), false, "medium")
  <textarea id='slp_materials_needed' name='slp_materials_needed' class='curriki-form1_textarea'></textarea>

  #curriki_formprompt($msg.get("ace.lesson.plan.enrichment.title"), $msg.get("ace.lesson.plan.enrichment.tooltip"), $msg.get("ace.lesson.plan.enrichment.instruction"), false, "medium")
  <textarea id='slp_enrichment' name='slp_enrichment' class='curriki-form1_textarea'></textarea>

  #curriki_formprompt($msg.get("ace.lesson.plan.accommodations.title"), $msg.get("ace.lesson.plan.accommodations.tooltip"), $msg.get("ace.lesson.plan.accommodations.instruction"), false, "medium")
  <textarea id='slp_accommodations' name='slp_accommodations' class='curriki-form1_textarea'></textarea>

  #curriki_formprompt($msg.get("ace.lesson.plan.anticipated.problems.title"), $msg.get("ace.lesson.plan.anticipated.problems.tooltip"), $msg.get("ace.lesson.plan.anticipated.problems.instruction"), false, "medium")
  <textarea id='slp_anticipated_problems' name='slp_anticipated_problems' class='curriki-form1_textarea'></textarea>

  #curriki_formprompt($msg.get("ace.lesson.plan.procedures.title"), $msg.get("ace.lesson.plan.procedures.tooltip"), $msg.get("ace.lesson.plan.procedures.instruction"), true, "medium")
  <div id="procedures_div"> </div>  <button class="button-orange" id="addRowBtn" onclick="return addrow();">$msg.get("ace.lesson.plan.procedures.addrow")</button>

## Required Resources (attachments) -- fileselection w/ buttons
  #curriki_formprompt($msg.get("lesson.plan.required.attachments.title"), $msg.get("lesson.plan.required.attachments.tooltip"), $msg.get("lesson.plan.required.attachments.instruction"), false, "")
<iframe src="$newAsset.getURL("view", "xpage=lpattachments")"
		onload="try { setAttachmentsIframeSize(); } catch(e) { alert('iframe onload error: '+e+' ...'); return false; }"
		id="attachment_iframe" name="attachment_iframe" width="100%" scrolling="auto" marginheight="0" marginwidth="0"	frameborder="0" >
  <h2>Sorry, your browser doesn't support iframes. Attachment Uploading functionality disabled.</h2>
</iframe>
  #curriki_formpart_end() ## }
####################################	step3
#curriki_createresources_step3()
####################################	step4
  #curriki_formpart_begin($msg.get("form.scratch.step4.header"))
  <p><label>$msg.get("ace.form.scratch.step4.instruction")</label></p>
  <p class="links">
	<button class="button-orange"
		onclick="try { if (document.forms.inline.onsubmit) document.forms.inline.onsubmit(); if (checkStandardLessonPlanForm()) { clearUnloadDialog(); startWaitingDialog(); document.forms.inline.action='$msg.get("form.done.url")'; document.forms.inline.submit(); } return false; } catch(e) { alert('$msg.get("form.scratch.submit.button") button onclick error: '+e+' ...'); return false; }"
	  >$msg.get("form.scratch.submit.button")</button>
	 #if( "$!cameFrom" != "" )
	   #set( $cancelURL = $cameFrom )
	 #else
	   #set( $cancelURL = $xwiki.getURL("Main.WebHome") ) ## cameFrom not set means go to WebHome
	 #end
	 <button class="cancel"
	  onclick="try { clearUnloadDialog(); window.location.href='$cancelURL'; return false; } catch(e) { alert('$msg.get("form.scratch.cancel.button") button onclick error: '+e+' ...'); return false; }"
	  >$msg.get("form.scratch.cancel.button")</button>
  </p>
  #curriki_formpart_end()
<!--

  <div class="tooltips">
	{pre} ##$xwiki.addTooltipJS() {/pre}
  </div>
-->
<div id="tooltip_div" class="tooltips"></div>
  </form>

{pre}
<script language="javascript" type="text/javascript">
function startWaitingDialog() {
#if( "$!noDialogs"!="1" )
  Curriki.showLoading();
#end
}
setUnloadDialog();
//tinyMCE.convertURL = function(url, node, on_save) { return url; };
</script>
{/pre}
#end ## } -- else, aka "$!newAsset"!=""
#end ## } -- $context.user=="XWiki.XWikiGuest"
